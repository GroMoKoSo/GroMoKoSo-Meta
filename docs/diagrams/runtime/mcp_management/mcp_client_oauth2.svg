<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="662px" preserveAspectRatio="none" style="width:895px;height:662px;background:#FFFFFF;" version="1.1" viewBox="0 0 895 662" width="895px" zoomAndPan="magnify"><defs/><g><g><title>MCP Client .Client.</title><rect fill="#000000" fill-opacity="0.00000" height="500.2793" width="8" x="95.229" y="81.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="99" x2="99" y1="81.4883" y2="581.7676"/></g><g><title>MCP Server .Resource Server.</title><rect fill="#000000" fill-opacity="0.00000" height="500.2793" width="8" x="560.2832" y="81.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="563.6133" x2="563.6133" y1="81.4883" y2="581.7676"/></g><g><title>Keycloak .Authorization Server.</title><rect fill="#000000" fill-opacity="0.00000" height="500.2793" width="8" x="781.3374" y="81.4883"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="784.9531" x2="784.9531" y1="81.4883" y2="581.7676"/></g><g class="participant participant-head" data-participant="client"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126.458" x="33" y="78.5352">MCP Client (Client)</text><ellipse cx="99.229" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M99.229,21.5 L99.229,48.5 M86.229,29.5 L112.229,29.5 M99.229,48.5 L86.229,63.5 M99.229,48.5 L112.229,63.5" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="client"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="126.458" x="33" y="594.3027">MCP Client (Client)</text><ellipse cx="99.229" cy="605.7559" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M99.229,613.7559 L99.229,640.7559 M86.229,621.7559 L112.229,621.7559 M99.229,640.7559 L86.229,655.7559 M99.229,640.7559 L112.229,655.7559" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="resource_server"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="197.3398" x="462.6133" y="78.5352">MCP Server (Resource Server)</text><ellipse cx="564.2832" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M564.2832,21.5 L564.2832,48.5 M551.2832,29.5 L577.2832,29.5 M564.2832,48.5 L551.2832,63.5 M564.2832,48.5 L577.2832,63.5" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="resource_server"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="197.3398" x="462.6133" y="594.3027">MCP Server (Resource Server)</text><ellipse cx="564.2832" cy="605.7559" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M564.2832,613.7559 L564.2832,640.7559 M551.2832,621.7559 L577.2832,621.7559 M564.2832,640.7559 L551.2832,655.7559 M564.2832,640.7559 L577.2832,655.7559" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="auth_server"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="212.7686" x="675.9531" y="78.5352">Keycloak (Authorization Server)</text><ellipse cx="785.3374" cy="13.5" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M785.3374,21.5 L785.3374,48.5 M772.3374,29.5 L798.3374,29.5 M785.3374,48.5 L772.3374,63.5 M785.3374,48.5 L798.3374,63.5" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="auth_server"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="212.7686" x="675.9531" y="594.3027">Keycloak (Authorization Server)</text><ellipse cx="785.3374" cy="605.7559" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M785.3374,613.7559 L785.3374,640.7559 M772.3374,621.7559 L798.3374,621.7559 M785.3374,640.7559 L772.3374,655.7559 M785.3374,640.7559 L798.3374,655.7559" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="message" data-participant-1="client" data-participant-2="resource_server"><polygon fill="#181818" points="552.2832,108.7988,562.2832,112.7988,552.2832,116.7988,556.2832,112.7988" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="99.229" x2="558.2832" y1="112.7988" y2="112.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247.1396" x="106.229" y="108.0566">MCP request without token (POST /sse)</text></g><g class="message" data-participant-1="resource_server" data-participant-2="client"><polygon fill="#181818" points="110.229,138.1094,100.229,142.1094,110.229,146.1094,106.229,142.1094" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="104.229" x2="563.2832" y1="142.1094" y2="142.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="357.6143" x="116.229" y="137.3672">HTTP 401 Unauthorized (with www-authenticate header)</text></g><path d="M5,155.1094 L5,195.1094 L193,195.1094 L193,165.1094 L183,155.1094 L5,155.1094" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M183,155.1094 L183,165.1094 L193,165.1094 L183,155.1094" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167.8003" x="11" y="172.6777">Extract resource_metadata</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149.957" x="15.1133" y="187.9883">from www-authenticate</text><g class="message" data-participant-1="client" data-participant-2="resource_server"><polygon fill="#181818" points="552.2832,218.041,562.2832,222.041,552.2832,226.041,556.2832,222.041" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="99.229" x2="558.2832" y1="222.041" y2="222.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="441.0542" x="106.229" y="217.2988">get resource metadata (GET /.well-known/oauth-protected-resource)</text></g><g class="message" data-participant-1="resource_server" data-participant-2="client"><polygon fill="#181818" points="110.229,247.3516,100.229,251.3516,110.229,255.3516,106.229,251.3516" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="104.229" x2="563.2832" y1="251.3516" y2="251.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="300.7266" x="116.229" y="246.6094">resource metadata with authorization server url</text></g><path d="M5,264.3516 L5,319.3516 L193,319.3516 L193,274.3516 L183,264.3516 L5,264.3516" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M183,264.3516 L183,274.3516 L193,274.3516 L183,264.3516" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131.9995" x="11" y="281.9199">validate rs metadata,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163.1982" x="15.1133" y="297.2305">build authorization server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="80.082" x="15.1133" y="312.541">metadata url</text><g class="message" data-participant-1="client" data-participant-2="auth_server"><polygon fill="#181818" points="773.3374,342.5938,783.3374,346.5938,773.3374,350.5938,777.3374,346.5938" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="99.229" x2="779.3374" y1="346.5938" y2="346.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="521.752" x="106.229" y="341.8516">get authorization server metadata (GET /.well-known/oauth-authorization-server)</text></g><g class="message" data-participant-1="auth_server" data-participant-2="client"><polygon fill="#181818" points="110.229,371.9043,100.229,375.9043,110.229,379.9043,106.229,375.9043" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="104.229" x2="784.3374" y1="375.9043" y2="375.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.0742" x="116.229" y="371.1621">authorization server metadata</text></g><path d="M13,388.9043 L13,413.9043 L869,413.9043 L869,398.9043 L859,388.9043 L13,388.9043" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M859,388.9043 L859,398.9043 L869,398.9043 L859,388.9043" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273.6919" x="300.0149" y="406.4727">OAuth 2.1 authorization flow happens here</text><g class="message" data-participant-1="client" data-participant-2="auth_server"><polygon fill="#181818" points="773.3374,436.5254,783.3374,440.5254,773.3374,444.5254,777.3374,440.5254" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="99.229" x2="779.3374" y1="440.5254" y2="440.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="299.1714" x="106.229" y="435.7832">exchange authorization code with access token</text></g><g class="message" data-participant-1="auth_server" data-participant-2="client"><polygon fill="#181818" points="110.229,465.8359,100.229,469.8359,110.229,473.8359,106.229,469.8359" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="104.229" x2="784.3374" y1="469.8359" y2="469.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86.0107" x="116.229" y="465.0938">Access Token</text></g><g class="message" data-participant-1="client" data-participant-2="resource_server"><polygon fill="#181818" points="552.2832,495.1465,562.2832,499.1465,552.2832,503.1465,556.2832,499.1465" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="99.229" x2="558.2832" y1="499.1465" y2="499.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271.3306" x="106.229" y="494.4043">MCP request with access token (POST /sse)</text></g><g class="message" data-participant-1="resource_server" data-participant-2="client"><polygon fill="#181818" points="110.229,524.457,100.229,528.457,110.229,532.457,106.229,528.457" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="104.229" x2="563.2832" y1="528.457" y2="528.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88.7847" x="116.229" y="523.7148">MCP response</text></g><path d="M17,541.457 L17,566.457 L644,566.457 L644,551.457 L634,541.457 L17,541.457" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M634,541.457 L634,551.457 L644,551.457 L634,541.457" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="298.6699" x="177.1416" y="559.0254">MCP communication continues with valid token</text><!--SRC=[bPDVJy8m5CNV_HGtFes4WXYVY34XX6XY34JccucftOKjTEriEuP-UZiwDlO7qATbRS_lddDx2m10cP4A68zG6A0Qhb-c2vYwNyzzUzTNK9vKg6Mg67veL5jKfMJfVhtNOhzOg6bfQi9ZtJD-Coxf1ho9tP4g-g4cagAIxhM5D_BGh3s6lB32hnIrWIooYDI0aHiKu2tcIn-6McFl679FI9lovFiBkBiPmPkWXGyCmCk1a6KPoHUjE6BK88H80-jj3nNIBiWyZSEFOROpocQjQiHeQ40DVHUmKZ9kyIubN6C5WmCClCUP3JV8a7Eo4J8JGvb3IQAi8sOm80VDvVHj-ZuuhTr8SMcfuYU2RocFWhm_IfUWlWtzcKOyw8JPpRBYWLirucXKN1Cw_LniI4r5dAhLabgjitKwm_VhW7a-ot0x63LGAoup26cIeD1sYXIUIumx5bAnnWQ3oG2Bws4CjNR3VZRFn1tqcmV_yfngLVxrf1n99r9eFD6qJWsJSPoA_6MukFQL26l7kTdFc3Fp2m00]--></g></svg>