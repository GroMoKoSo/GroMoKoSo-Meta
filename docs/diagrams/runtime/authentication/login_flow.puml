@startuml Login Flow
title Login Flow (Authorization Code + PKCE)

actor User
participant UI
participant "Keycloak (IdP)" as KC
participant Backend

User -> UI: Click "Login"
UI -> KC: Redirect to /auth\n(client_id, scope, code_challenge, redirect_uri)
User -> KC: Enter credentials (username, password, 2FA)

alt Invalid credentials
    KC -> User: Show error message
else Valid credentials
    KC -> UI: Redirect with Authorization Code
    UI -> Backend: Send Authorization Code + Code Verifier
    Backend -> KC: POST /token\n(grant_type=authorization_code,\nclient_id, code, code_verifier)
    KC --> Backend: Access Token + ID Token + Refresh Token
    Backend --> UI: Tokens stored in secure session/cookie
    UI --> User: Redirected to app, logged in
end

@enduml
